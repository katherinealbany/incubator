#!/bin/bash -e
set -o pipefail
[[ -n "${DEBUG}" ]] && set -x

###################################################################################################

BASE="$(dirname ${BASH_SOURCE[0]})"

###################################################################################################

"${BASE}/clean.sh"

###################################################################################################

[[ -f "${BASE}/environment" ]] && source "${BASE}/environment"

###################################################################################################

[[ -z "${TEMPLATE_EXTENSION}" ]] && TEMPLATE_EXTENSION='.tmpl'
TEMPLATES="$(find "${BASE}" -name "*${TEMPLATE_EXTENSION}" -mindepth 1 -maxdepth 1 -print)"

###################################################################################################

for INPUT_FILE in ${TEMPLATES}; do
  #################################################################################################
  #################################################################################################
  OUTPUT_FILE="$(echo "${INPUT_FILE}" | sed "s/${TEMPLATE_EXTENSION}//g")"
  yamllint --config-file "${BASE}/.yamllint" --strict ${INPUT_FILE}
  gomplate --file "${INPUT_FILE}" --out - | tee "${OUTPUT_FILE}"
  yamllint --config-file "${BASE}/.yamllint" --strict ${OUTPUT_FILE}
  #################################################################################################
  #################################################################################################
done

###################################################################################################

exit 0

###################################################################################################
