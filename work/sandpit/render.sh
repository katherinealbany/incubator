#!/bin/bash -e
set -o pipefail
[[ -n "${DEBUG}" ]] && set -x

###################################################################################################

[[ -n "${1}" ]] && cd "${1}"

###################################################################################################

BASE="$(dirname "${BASH_SOURCE[0]}")"

###################################################################################################

[[ -f ./environment ]] && source ./environment

###################################################################################################

[[ -z "${TEMPLATE_DELIMITER}"    ]] && TEMPLATE_DELIMITER='.'
[[ -z "${TEMPLATE_EXTENSION}"    ]] && TEMPLATE_EXTENSION='tmpl'
[[ -z "${YAML_LINT_CONFIG_FILE}" ]] && YAML_LINT_CONFIG_FILE='./.yamllint'

###################################################################################################

git clean -f -X .

###################################################################################################

TEMPLATES="$(find . -name "*${TEMPLATE_DELIMITER}${TEMPLATE_EXTENSION}" -print)"

###################################################################################################

for INPUT in ${TEMPLATES}; do
  #################################################################################################
  #################################################################################################
  OUTPUT="$(echo "${INPUT}" | sed "s/${TEMPLATE_DELIMITER}${TEMPLATE_EXTENSION}//g")"

  gomplate --file "${INPUT}" --out - | tee "${OUTPUT}"

  EXTENSION="$(echo "${OUTPUT}" | rev | awk -F"${TEMPLATE_DELIMITER}" '{print $1}' | rev)"

  case ${EXTENSION} in
    sh)
      chmod -v u+x "${OUTPUT}"
      ;;
    yaml)
      yamllint --config-file "${YAML_LINT_CONFIG_FILE}" --strict ${OUTPUT}
      ;;
  esac
  #################################################################################################
  #################################################################################################
done

###################################################################################################

exit 0

###################################################################################################
